version: "3.8"

services:
  # -------------------------
  # Ethereum Node 1 (minero principal)
  # -------------------------
  geth-node1:
    image: ethereum/client-go:stable
    container_name: geth-node1
    entrypoint: >
      sh -c "
        if [ ! -d /root/.ethereum/geth ]; then
          echo 'Inicializando nodo 1...';
          geth --datadir /root/.ethereum init /ethereum/genesis.json;
        fi;
        exec geth
          --networkid 2025
          --datadir /root/.ethereum
          --http
          --http.addr 0.0.0.0
          --http.port 8545
          --http.api personal,eth,net,web3,miner,clique
          --http.corsdomain='*'
          --allow-insecure-unlock
          --mine
          --miner.threads=1
          --unlock 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
          --password /ethereum/passwords.txt
          --verbosity 3
          --nodiscover
      "
    ports:
      - "8545:8545"
      - "30303:30303"
    volumes:
      - ./ethereum:/ethereum
      - ./volumes/geth/node1:/root/.ethereum
    networks:
      - tfm_network

  # -------------------------
  # Ethereum Node 2 (seguidor)
  # -------------------------
  geth-node2:
    image: ethereum/client-go:stable
    container_name: geth-node2
    entrypoint: >
      sh -c "
        if [ ! -d /root/.ethereum/geth ]; then
          echo 'Inicializando nodo 2...';
          geth --datadir /root/.ethereum init /ethereum/genesis.json;
        fi;
        # Esperar a que el nodo 1 est√© disponible
        sleep 5;
        exec geth
          --networkid 2025
          --datadir /root/.ethereum
          --http
          --http.addr 0.0.0.0
          --http.port 8546
          --http.api personal,eth,net,web3,clique
          --allow-insecure-unlock
          --unlock 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
          --password /ethereum/passwords.txt
          --verbosity 3
          --bootnodes enode://$(cat /ethereum/node1_enode.txt)
          --nodiscover
      "
    ports:
      - "8546:8546"
      - "30304:30303"
    depends_on:
      - geth-node1
    volumes:
      - ./ethereum:/ethereum
      - ./volumes/geth/node2:/root/.ethereum
    networks:
      - tfm_network

networks:
  app-network:
    external: true
